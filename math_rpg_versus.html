<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Math RPG: Wizard Duel</title>
<style>
  :root { color-scheme: dark; }
  body { background:#1a1a1a; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin:0; text-align:center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
  #game-wrapper { display: flex; flex-direction: column; align-items: center; }
  canvas { background:#3d2a42; display:block; border:2px solid #555; image-rendering: pixelated; image-rendering: crisp-edges; }
  #ui-panel { background: #2c3e50; width: 800px; padding: 1rem; border: 2px solid #555; border-top: none; box-sizing: border-box; }
  #problem-text { font-size: 32px; font-weight: bold; }
  #answer-input { font-size: 28px; width: 120px; text-align: center; margin: 0 10px; }
  #attack-button { font-size: 28px; padding: 5px 15px; cursor: pointer; }
  #message-log { margin-top: 10px; height: 24px; font-size: 18px; color: #f1c40f; }
  #game-over-screen { display: none; position: absolute; background: rgba(0,0,0,0.8); width: 100%; height: 100%; top: 0; left: 0; flex-direction: column; align-items: center; justify-content: center; }
  #restart-button { font-size: 24px; padding: 10px 20px; margin-top: 20px; cursor: pointer; }
</style>
</head>
<body>

<div id="game-wrapper">
    <h1>Math RPG: Wizard Duel</h1>
    <canvas id="gameCanvas" width="800" height="400" aria-label="Game canvas"></canvas>
    <div id="ui-panel">
        <form id="answer-form">
            <span id="problem-text"></span>
            <input type="number" id="answer-input" autocomplete="off" required>
            <button type="submit" id="attack-button">Attack!</button>
        </form>
        <div id="message-log">Player 1's turn!</div>
    </div>
</div>

<div id="game-over-screen">
    <h2 id="end-message"></h2>
    <button id="restart-button">Play Again</button>
</div>

<script>
'use strict';

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// UI Elements
const problemTextEl = document.getElementById('problem-text');
const answerForm = document.getElementById('answer-form');
const answerInput = document.getElementById('answer-input');
const messageLogEl = document.getElementById('message-log');
const gameOverScreen = document.getElementById('game-over-screen');
const endMessageEl = document.getElementById('end-message');
const restartButton = document.getElementById('restart-button');

// Game State
let player1, player2, activePlayer, currentAnswer, projectiles, audioAssets;

// --- NEW: Audio Asset Loading ---
const audioAssetUrls = {
    attack: 'sound/magic-spell.mp3',
    hurt: 'sound/hit-damage.mp3'
};
let assetsLoaded = 0;
const totalAssets = Object.keys(audioAssetUrls).length;

function assetLoaded() {
    assetsLoaded++;
    if (assetsLoaded === totalAssets) {
        initGame(); // Start the game only after all sounds are ready
    }
}

function loadAudio() {
    audioAssets = {};
    Object.keys(audioAssetUrls).forEach(key => {
        audioAssets[key] = new Audio(audioAssetUrls[key]);
        audioAssets[key].addEventListener('canplaythrough', assetLoaded, { once: true });
    });
}

function initGame() {
    player1 = { name: "Player 1", x: 150, y: 250, width: 50, height: 80, hp: 100, maxHp: 100, color: '#7e22ce', hurtTimer: 0 };
    player2 = { name: "Player 2", x: 600, y: 250, width: 50, height: 80, hp: 100, maxHp: 100, color: '#2980b9', hurtTimer: 0 };
    activePlayer = player1;
    
    gameOverScreen.style.display = 'none';
    answerInput.disabled = false;
    document.getElementById('attack-button').disabled = false;
    
    messageLogEl.textContent = `${activePlayer.name}'s turn!`;
    projectiles = [];
    generateNewProblem();
    loop(); // Start the main game loop
}

function generateNewProblem() {
    const num1 = Math.floor(Math.random() * 12) + 1;
    const num2 = Math.floor(Math.random() * 12) + 1;
    currentAnswer = num1 + num2;
    problemTextEl.textContent = `${activePlayer.name}, solve: ${num1} + ${num2} =`;
    answerInput.value = '';
    answerInput.focus();
}

function drawHealthBar(x, y, width, height, currentHp, maxHp, color) {
    ctx.fillStyle = '#333';
    ctx.fillRect(x, y, width, height);
    const hpWidth = Math.max(0, (currentHp / maxHp) * width);
    ctx.fillStyle = color;
    ctx.fillRect(x, y, hpWidth, height);
    ctx.strokeStyle = 'white';
    ctx.strokeRect(x, y, width, height);
}

function drawWizard(player) {
    // Hurt animation: flash red
    if (player.hurtTimer > 0) {
        ctx.fillStyle = 'red';
        player.hurtTimer--;
    } else {
        ctx.fillStyle = player.color; // Robe
    }
    ctx.fillRect(player.x, player.y, player.width, player.height);
    ctx.fillStyle = '#f2d4a9'; // Face
    ctx.fillRect(player.x + 10, player.y + 5, player.width - 20, 20);
}

function drawProjectiles() {
    ctx.fillStyle = '#f1c40f'; // Yellow magic bolt
    projectiles.forEach(p => ctx.fillRect(p.x, p.y, 15, 15));
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Ground
    ctx.fillStyle = '#27ae60';
    ctx.fillRect(0, 330, canvas.width, 70);

    drawWizard(player1);
    drawWizard(player2);
    drawProjectiles();

    // Health Bars
    drawHealthBar(player1.x, player1.y - 20, player1.width, 10, player1.hp, player1.maxHp, 'green');
    drawHealthBar(player2.x, player2.y - 20, player2.width, 10, player2.hp, player2.maxHp, 'cyan');

    // HP Text
    ctx.fillStyle = 'white';
    ctx.font = '14px sans-serif';
    ctx.fillText(`HP: ${player1.hp}/${player1.maxHp}`, player1.x, player1.y - 25);
    ctx.fillText(`HP: ${player2.hp}/${player2.maxHp}`, player2.x, player2.y - 25);
}

function switchTurn() {
    activePlayer = (activePlayer === player1) ? player2 : player1;
    messageLogEl.textContent = `${activePlayer.name}'s turn!`;
    answerInput.disabled = false;
    document.getElementById('attack-button').disabled = false;
    generateNewProblem();
}

function updateProjectiles() {
    projectiles.forEach((p, index) => {
        // Move projectile
        p.x += p.dx;

        // Check for hit
        if ((p.dx > 0 && p.x >= p.target.x) || (p.dx < 0 && p.x <= p.target.x)) {
            p.target.hp = Math.max(0, p.target.hp - p.damage);
            audioAssets.hurt.cloneNode().play(); // Play hurt sound
            p.target.hurtTimer = 15; // Set hurt timer for 15 frames
            messageLogEl.textContent = `${p.attacker.name} dealt ${p.damage} damage!`;
            projectiles.splice(index, 1); // Remove projectile

            if (p.target.hp <= 0) {
                endBattle(p.attacker);
            } else {
                setTimeout(switchTurn, 1500); // Wait before switching turns
            }
        }
    });
}

function handleAnswer(e) {
    e.preventDefault();
    answerInput.disabled = true;
    document.getElementById('attack-button').disabled = true;

    const userAnswer = parseInt(answerInput.value, 10);
    const opponent = (activePlayer === player1) ? player2 : player1;

    if (userAnswer === currentAnswer) {
        // Correct answer: create a projectile
        const damage = Math.floor(Math.random() * 11) + 15; // 15-25 damage
        const projectile = {
            x: activePlayer.x + activePlayer.width / 2,
            y: activePlayer.y + activePlayer.height / 2,
            dx: (activePlayer === player1) ? 10 : -10, // Direction
            damage: damage,
            attacker: activePlayer,
            target: opponent
        };
        projectiles.push(projectile);
        audioAssets.attack.cloneNode().play(); // Play attack sound
        messageLogEl.textContent = `Correct! ${activePlayer.name} casts a spell!`;
    } else {
        // Incorrect answer, turn is missed
        messageLogEl.textContent = `Incorrect! ${activePlayer.name} missed their turn.`;
        setTimeout(switchTurn, 1500); // Wait before switching turns
    }
}

function endBattle(winner) {
    answerInput.disabled = true;
    document.getElementById('attack-button').disabled = true;
    
    endMessageEl.textContent = `${winner.name} is victorious!`;
    
    draw();
    gameOverScreen.style.display = 'flex';
}

answerForm.addEventListener('submit', handleAnswer);
restartButton.addEventListener('click', initGame);

function loop() {
    draw();
    updateProjectiles();
    requestAnimationFrame(loop);
}

loadAudio(); // Start loading assets, which will then call initGame()

</script>
</body>
</html>